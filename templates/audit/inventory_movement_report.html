{% extends 'base.html' %}
{% load humanize %}

{% block title %}Inventory Movement Report{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="bi bi-arrow-left-right text-primary me-2"></i>
                        Inventory Movement Report
                    </h1>
                    <p class="text-muted mb-0">Track all inventory movements across the system</p>
                </div>
                <div class="d-flex gap-2 mt-2 mt-md-0">
                    <a href="{% url 'audit:product_lifecycle' %}" class="btn btn-outline-primary">
                        <i class="bi bi-diagram-3 me-1"></i> Product Lifecycle
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Transaction Type</label>
                    <select name="type" class="form-select">
                        <option value="">All Types</option>
                        {% for code, label in transaction_types %}
                        <option value="{{ code }}" {% if filters.type == code %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Location</label>
                    <select name="location" class="form-select">
                        <option value="">All Locations</option>
                        {% for loc in locations %}
                        <option value="{{ loc.id }}"
                            {% if filters.location == loc.id|stringformat:"s" %}selected{% endif %}>
                            {{ loc.name }} ({{ loc.get_location_type_display }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-semibold">From Date</label>
                    <input type="date" name="date_from" class="form-control" value="{{ filters.date_from }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-semibold">To Date</label>
                    <input type="date" name="date_to" class="form-control" value="{{ filters.date_to }}">
                </div>
                <div class="col-md-2 d-flex align-items-end gap-2">
                    <button type="submit" class="btn btn-primary flex-grow-1">
                        <i class="bi bi-filter me-1"></i> Filter
                    </button>
                    <a href="{% url 'audit:inventory_movements' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-lg"></i>
                    </a>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-semibold">Product Search</label>
                    <input type="text" name="product" class="form-control" placeholder="Product name or SKU..."
                        value="{{ filters.product }}">
                </div>
            </form>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        {% for type_code, data in summary.items %}
        <div class="col-auto mb-2">
            <div
                class="card shadow-sm {% if data.qty > 0 %}border-success{% elif data.qty < 0 %}border-danger{% else %}border-secondary{% endif %}">
                <div class="card-body py-2 px-3">
                    <div class="d-flex align-items-center gap-2">
                        <span
                            class="badge {% if data.qty > 0 %}bg-success{% elif data.qty < 0 %}bg-danger{% else %}bg-secondary{% endif %}">
                            {{ type_code }}
                        </span>
                        <div>
                            <span class="fw-bold">{{ data.count }}</span>
                            <small class="text-muted">entries</small>
                        </div>
                        <div class="border-start ps-2">
                            <span
                                class="{% if data.qty > 0 %}text-success{% elif data.qty < 0 %}text-danger{% endif %}">
                                {% if data.qty > 0 %}+{% endif %}{{ data.qty|floatformat:0 }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-secondary mb-0">
                <i class="bi bi-info-circle me-2"></i> No movements match the current filters.
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Movements Table -->
    <div class="card shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-journal-text me-2"></i>
                Movement Details
                <span class="badge bg-primary ms-2">{{ ledger|length }} entries</span>
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th class="text-white">Date/Time</th>
                            <th class="text-white">Type</th>
                            <th class="text-white">Product</th>
                            <th class="text-white">Location</th>
                            <th class="text-white">Batch</th>
                            <th class="text-end text-white">Quantity</th>
                            <th class="text-end text-white">Unit Cost</th>
                            <th class="text-white">Reference</th>
                            <th class="text-white">By</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in ledger %}
                        <tr>
                            <td>
                                <small>{{ entry.created_at|date:"d M Y" }}</small><br>
                                <small class="text-muted">{{ entry.created_at|time:"H:i:s" }}</small>
                            </td>
                            <td>
                                <span class="badge {% if entry.quantity > 0 %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ entry.get_transaction_type_display }}
                                </span>
                            </td>
                            <td>
                                <a href="{% url 'audit:product_lifecycle_detail' entry.product.id %}"
                                    class="text-decoration-none">
                                    <strong>{{ entry.product.name }}</strong>
                                </a>
                                <br><small class="text-muted">{{ entry.product.sku }}</small>
                            </td>
                            <td>
                                {{ entry.location.name }}
                                <br><small class="text-muted">{{ entry.location.get_location_type_display }}</small>
                            </td>
                            <td>
                                {% if entry.batch %}
                                <small>{{ entry.batch.batch_number }}</small>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td
                                class="text-end fw-semibold {% if entry.quantity > 0 %}text-success{% else %}text-danger{% endif %}">
                                {% if entry.quantity > 0 %}+{% endif %}{{ entry.quantity|floatformat:2 }}
                            </td>
                            <td class="text-end">
                                {% if entry.unit_cost %}
                                {{ currency_symbol }}{{ entry.unit_cost|floatformat:2 }}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if entry.reference_type and entry.reference_id %}
                                <small>{{ entry.reference_type }} #{{ entry.reference_id }}</small>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if entry.created_by %}
                                <small>{{ entry.created_by.get_full_name|default:entry.created_by.email }}</small>
                                {% else %}
                                <span class="text-muted">System</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center text-muted py-4">
                                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                No inventory movements found
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% include 'includes/audit_pagination.html' %}
    </div>
</div>
{% endblock %}