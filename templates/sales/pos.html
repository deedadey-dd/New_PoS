{% load static %}
<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS - {{ shop.name }}</title>
    <link rel="icon" type="image/png" href="{% static 'images/cart_icon.png' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Paystack Inline JS for E-Cash payments -->
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <style>
        :root {
            --pos-primary: #4f46e5;
            --pos-success: #10b981;
            --pos-warning: #f59e0b;
            --pos-danger: #ef4444;
        }

        body {
            background: #1e1e2e;
            color: #fff;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .pos-header {
            background: linear-gradient(135deg, var(--pos-primary), #6366f1);
            padding: 0.75rem 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }

        .pos-main {
            height: calc(100vh - 56px);
            min-height: 0;
            display: flex;
            overflow: hidden;
        }

        .pos-main.with-banner {
            height: calc(100vh - 94px);
        }

        .products-section {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background: #262638;
        }

        .cart-section {
            width: 380px;
            background: #1a1a2e;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #333;
            height: 100%;
            overflow: hidden;
        }

        .search-box {
            position: relative;
        }

        .search-box input.form-control {
            background: #333 !important;
            border: 1px solid #444;
            color: #fff !important;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border-radius: 8px;
            font-size: 1rem;
        }

        .search-box input.form-control::placeholder {
            color: #aaa;
        }

        .search-box input:focus {
            background: #3a3a4e;
            border-color: var(--pos-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
        }

        .search-box i {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
            z-index: 1;
        }

        /* Autocomplete suggestions */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #333;
            border: 1px solid #444;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-suggestions.show {
            display: block;
        }

        .suggestion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #444;
            transition: background 0.15s;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover,
        .suggestion-item.active {
            background: var(--pos-primary);
        }

        .suggestion-name {
            font-weight: 500;
        }

        .suggestion-sku {
            font-size: 0.8rem;
            color: #aaa;
            margin-left: 0.5rem;
        }

        .suggestion-item:hover .suggestion-sku,
        .suggestion-item.active .suggestion-sku {
            color: rgba(255, 255, 255, 0.7);
        }

        .suggestion-price {
            color: var(--pos-success);
            font-weight: 600;
        }

        .suggestion-item:hover .suggestion-price,
        .suggestion-item.active .suggestion-price {
            color: #fff;
        }

        .suggestion-empty {
            padding: 1rem;
            text-align: center;
            color: #888;
        }

        .category-tabs {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .category-tab {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background: #333;
            border: none;
            color: #ccc;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .category-tab:hover,
        .category-tab.active {
            background: var(--pos-primary);
            color: #fff;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .product-card {
            background: #333;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-2px);
            border-color: var(--pos-primary);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .product-name {
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .product-price {
            color: var(--pos-success);
            font-weight: 700;
            font-size: 1rem;
        }

        .product-quantity-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            min-width: 24px;
            height: 24px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            color: #fff;
            padding: 0 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .badge-good {
            background: var(--pos-success);
        }

        .badge-warning {
            background: var(--pos-warning);
        }

        .badge-critical {
            background: var(--pos-danger);
        }

        /* Cart Styles */
        .cart-header {
            padding: 1rem;
            border-bottom: 1px solid #333;
            flex-shrink: 0;
        }

        .cart-items {
            flex: 1 1 50px;
            overflow-y: auto;
            padding: 0.5rem;
            min-height: 50px;
        }

        .cart-item {
            background: #262638;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-item-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .cart-item-qty {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .qty-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            background: #444;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qty-btn:hover {
            background: var(--pos-primary);
        }

        .qty-value {
            min-width: 30px;
            text-align: center;
            font-weight: 600;
        }

        .cart-item-remove {
            color: var(--pos-danger);
            cursor: pointer;
            padding: 0.25rem;
        }

        .cart-summary {
            border-top: 1px solid #333;
            padding: 0.5rem 1rem;
            flex-shrink: 0;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .summary-total {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--pos-success);
        }

        .cart-actions {
            padding: 0.5rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            flex-shrink: 0;
        }

        .customer-section {
            padding: 0 1rem;
            flex-shrink: 0;
            position: relative;
        }

        .customer-suggestions {
            position: absolute;
            top: 100%;
            left: 1rem;
            right: 1rem;
            background: #333;
            border: 1px solid #444;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .customer-suggestions.show {
            display: block;
        }

        .btn-pay {
            padding: 0.6rem 1rem;
            font-size: 0.95rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .btn-pay-cash {
            background: var(--pos-success);
            color: #fff;
        }

        .btn-pay-ecash {
            background: #6366f1;
            color: #fff;
        }

        .btn-pay:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        .btn-pay:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Empty cart */
        .cart-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
        }

        .cart-empty i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Modal */
        .checkout-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .checkout-modal.active {
            display: flex;
        }

        .checkout-dialog {
            background: #262638;
            border-radius: 16px;
            padding: 2rem;
            width: 400px;
            max-width: 90%;
        }

        .checkout-input {
            background: #333;
            border: 2px solid #444;
            color: #fff;
            padding: 1rem;
            font-size: 1.5rem;
            border-radius: 8px;
            text-align: center;
            width: 100%;
        }

        .checkout-input:focus {
            border-color: var(--pos-primary);
            outline: none;
        }

        /* Shift banner */
        .shift-banner {
            background: var(--pos-warning);
            color: #000;
            padding: 0.5rem 1rem;
            text-align: center;
        }

        /* Mobile Cart Toggle Button */
        .mobile-cart-toggle {
            display: none;
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--pos-primary);
            border: none;
            color: #fff;
            font-size: 1.5rem;
            z-index: 900;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            cursor: pointer;
        }

        .mobile-cart-toggle .cart-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--pos-danger);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Tablet Breakpoint (max-width: 992px) */
        @media (max-width: 992px) {
            .pos-main {
                flex-direction: column;
                height: auto;
                min-height: calc(100vh - 56px);
            }

            .pos-main.with-banner {
                min-height: calc(100vh - 94px);
            }

            .products-section {
                flex: none;
                height: auto;
                min-height: 50vh;
                padding-bottom: 100px;
            }

            .cart-section {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: 70vh;
                max-height: 70vh;
                transform: translateY(calc(100% - 60px));
                transition: transform 0.3s ease;
                z-index: 800;
                border-left: none;
                border-top: 2px solid var(--pos-primary);
                border-radius: 20px 20px 0 0;
            }

            .cart-section.expanded {
                transform: translateY(0);
            }

            .cart-section::before {
                content: '';
                display: block;
                width: 40px;
                height: 4px;
                background: #555;
                border-radius: 2px;
                margin: 8px auto;
                cursor: pointer;
            }

            .cart-header {
                cursor: pointer;
                padding: 0.5rem 1rem;
            }

            .mobile-cart-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 0.5rem;
            }

            .product-card {
                padding: 0.75rem;
            }

            .product-name {
                font-size: 0.8rem;
            }

            .product-price {
                font-size: 0.9rem;
            }
        }

        /* Phone Breakpoint (max-width: 576px) */
        @media (max-width: 576px) {
            .pos-header {
                padding: 0.5rem;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .pos-header h5 {
                font-size: 0.9rem;
            }

            .shift-banner {
                font-size: 0.85rem;
                padding: 0.4rem 0.5rem;
            }

            .search-box input.form-control {
                padding: 0.6rem 1rem 0.6rem 2rem;
                font-size: 0.9rem;
            }

            .category-tabs {
                gap: 0.3rem;
            }

            .category-tab {
                padding: 0.4rem 0.75rem;
                font-size: 0.85rem;
            }

            .products-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.4rem;
            }

            .product-card {
                padding: 0.5rem;
                border-radius: 8px;
            }

            .product-name {
                font-size: 0.75rem;
                -webkit-line-clamp: 1;
            }

            .product-price {
                font-size: 0.85rem;
            }

            .cart-section {
                height: 80vh;
                max-height: 80vh;
            }

            .cart-item {
                padding: 0.5rem;
            }

            .cart-item-name {
                font-size: 0.85rem;
            }

            .qty-btn {
                width: 32px;
                height: 32px;
            }

            .btn-pay {
                padding: 0.75rem;
                font-size: 1rem;
            }

            .cart-summary {
                padding: 0.5rem;
            }

            .summary-total {
                font-size: 1.1rem;
            }

            .checkout-dialog {
                width: 95%;
                padding: 1.5rem;
            }

            .checkout-input {
                font-size: 1.25rem;
                padding: 0.75rem;
            }
        }

        @media print {
            body * {
                visibility: hidden;
            }

            .receipt-print,
            .receipt-print * {
                visibility: visible;
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="pos-header d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
            <h5 class="mb-0"><i class="bi bi-shop me-2"></i>{{ shop.name }}</h5>
        </div>
        <div class="d-flex align-items-center gap-3">
            {% if shift %}
            <span class="badge bg-success"><i class="bi bi-clock me-1"></i>Shift Open</span>
            <a href="{% url 'sales:shift_close' shift.pk %}" class="btn btn-outline-light btn-sm">Close Shift</a>
            {% else %}
            <a href="{% url 'sales:shift_open' %}" class="btn btn-warning btn-sm">Open Shift</a>
            {% endif %}
            <a href="{% url 'core:dashboard' %}" class="btn btn-outline-light btn-sm" title="Dashboard">
                <i class="bi bi-speedometer2"></i>
            </a>
            <span class="text-light">{{ user.get_full_name|default:user.email }}</span>
            <a href="{% url 'core:logout' %}" class="btn btn-outline-light btn-sm">
                <i class="bi bi-box-arrow-right"></i>
            </a>
        </div>
    </header>

    {% if not shift %}
    <div class="shift-banner">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>No open shift!</strong> Please open a shift before making sales.
        <a href="{% url 'sales:shift_open' %}" class="btn btn-dark btn-sm ms-2">Open Shift Now</a>
    </div>
    {% endif %}

    <main class="pos-main{% if not shift %} with-banner{% endif %}">
        <!-- Products Section -->
        <div class="products-section">
            <div class="search-box">
                <i class="bi bi-search"></i>
                <input type="text" id="product-search" class="form-control"
                    placeholder="Search products by name, SKU, or barcode..." autocomplete="off">
                <div class="search-suggestions" id="search-suggestions"></div>
            </div>

            <div class="category-tabs">
                <button class="category-tab active" data-category="all">All</button>
                {% for category in categories %}
                <button class="category-tab" data-category="{{ category.name }}">{{ category.name }}</button>
                {% endfor %}
            </div>

            <div class="products-grid" id="products-grid">
                <!-- Products loaded via JavaScript -->
            </div>
        </div>

        <!-- Cart Section -->
        <div class="cart-section">
            <div class="cart-header">
                <h5 class="mb-0"><i class="bi bi-cart3 me-2"></i>Cart <span id="cart-count"
                        class="badge bg-primary">0</span></h5>
            </div>

            <div class="cart-items" id="cart-items">
                <div class="cart-empty">
                    <i class="bi bi-cart-x"></i>
                    <p>Cart is empty</p>
                    <small>Click products to add</small>
                </div>
            </div>

            <div class="cart-summary">
                <div class="summary-row">
                    <span>Subtotal</span>
                    <span id="cart-subtotal">{{ currency_symbol }}0.00</span>
                </div>
                <div class="summary-row">
                    <span>Discount</span>
                    <span id="cart-discount">-{{ currency_symbol }}0.00</span>
                </div>
                <div class="summary-row summary-total">
                    <span>Total</span>
                    <span id="cart-total">{{ currency_symbol }}0.00</span>
                </div>
            </div>

            <!-- Customer Selection -->
            <div class="customer-section">
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-dark border-secondary"><i class="bi bi-person"></i></span>
                    <input type="text" id="customer-search" class="form-control bg-dark text-white border-secondary"
                        placeholder="Customer (optional)">
                    <button class="btn btn-outline-secondary" type="button" id="btn-clear-customer"
                        style="display: none;">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <!-- Customer Info Display -->
                <div id="selected-customer-info" class="small mt-1 p-2 rounded bg-dark"
                    style="display: none; border: 1px dashed #555;">
                    <div class="d-flex justify-content-between">
                        <span class="fw-bold" id="cust-name"></span>
                        <span id="cust-balance"></span>
                    </div>
                    <div class="text-muted small" id="cust-limit"></div>
                </div>
                <!-- Customer Suggestions -->
                <div class="customer-suggestions" id="customer-suggestions"></div>
            </div>

            <div class="cart-actions">
                <button class="btn-pay btn-pay-cash" id="btn-pay-cash" disabled>
                    <i class="bi bi-cash"></i> Pay Cash
                </button>
                <button class="btn-pay btn-pay-credit" id="btn-pay-credit" disabled
                    style="background: #e11d48; display: none;">
                    <i class="bi bi-credit-card-2-front"></i> Sell on Credit
                </button>
                {% if shop_settings.enable_ecash_payment %}
                <button class="btn-pay btn-pay-ecash" id="btn-pay-ecash" disabled>
                    <i class="bi bi-credit-card"></i> Pay E-Cash
                </button>
                {% endif %}
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-warning flex-fill" id="btn-discount">
                        <i class="bi bi-percent"></i> Discount
                    </button>
                    <button class="btn btn-outline-danger flex-fill" id="btn-clear-cart">
                        <i class="bi bi-trash"></i> Clear
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Checkout Modal -->
    <div class="checkout-modal" id="checkout-modal">
        <div class="checkout-dialog">
            <h4 class="mb-4 text-center" id="checkout-title"><i class="bi bi-cash-coin me-2"></i>Cash Payment</h4>
            <div class="mb-3">
                <label class="form-label">Total Due</label>
                <div class="h2 text-success" id="modal-total">{{ currency_symbol }}0.00</div>
            </div>

            <!-- Credit Info (Hidden by default) -->
            <div id="credit-payment-info" class="mb-3 alert alert-warning" style="display: none;">
                <div class="d-flex justify-content-between">
                    <span>Current Balance:</span>
                    <strong id="credit-current-balance">0.00</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>New Balance:</span>
                    <strong id="credit-new-balance">0.00</strong>
                </div>
                <div class="small mt-2" id="credit-limit-warning"></div>
            </div>

            <div class="mb-4" id="amount-received-container">
                <label class="form-label">Amount Received</label>
                <input type="number" class="checkout-input" id="amount-received" step="0.01" min="0" autofocus>
            </div>
            <div class="mb-4" id="change-container">
                <label class="form-label">Change</label>
                <div class="h3" id="modal-change">{{ currency_symbol }}0.00</div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-secondary flex-fill" onclick="closeCheckoutModal()">Cancel</button>
                <button class="btn btn-success flex-fill" id="btn-complete-sale">Complete Sale</button>
            </div>
        </div>
    </div>

    <!-- Shift Prompt Modal -->
    <div class="checkout-modal" id="shift-prompt-modal">
        <div class="checkout-dialog">
            <h4 class="mb-4 text-center text-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>No Shift Open
            </h4>
            <p class="text-center mb-4">
                You don't have an open shift. Sales made without a shift won't be tracked for cash balancing.
            </p>
            <div class="d-flex flex-column gap-2">
                <button class="btn btn-success btn-lg" onclick="openShiftAndReturn()">
                    <i class="bi bi-clock me-2"></i>Open Shift First
                </button>
                <button class="btn btn-outline-warning" onclick="continueWithoutShift()">
                    <i class="bi bi-cash-coin me-2"></i>Continue Without Shift
                </button>
                <button class="btn btn-outline-secondary" onclick="closeShiftPromptModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Cart Toggle Button -->
    <button class="mobile-cart-toggle" id="mobile-cart-toggle" onclick="toggleMobileCart()">
        <i class="bi bi-cart3"></i>
        <span class="cart-badge" id="mobile-cart-badge">0</span>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const CURRENCY = '{{ currency_symbol }}';
        const PRODUCTS = {{ products| safe }};
        const CUSTOMERS = {{ customers| safe }};
        const CSRF_TOKEN = '{{ csrf_token }}';
        const HAS_SHIFT = {% if shift %}true{% else %} false{% endif %};

        let cart = [];
        let discountAmount = 0;
        let currentCategory = 'all';
        let selectedCustomer = null;
        let paymentMode = 'CASH'; // CASH, ECASH, CREDIT
        let pendingPaymentMode = null; // For shift check continuation

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            renderProducts();
            loadCartFromStorage();
            initSearchAutocomplete();
            initCustomerSearch(); // NEW

            // Category tabs
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentCategory = this.dataset.category;
                    renderProducts();
                });
            });

            // Payment buttons - check for open shift first
            document.getElementById('btn-pay-cash').addEventListener('click', () => {
                if (checkShiftBeforePayment('CASH')) openCheckout('CASH');
            });
            if (document.getElementById('btn-pay-credit')) {
                document.getElementById('btn-pay-credit').addEventListener('click', () => {
                    if (checkShiftBeforePayment('CREDIT')) openCheckout('CREDIT');
                });
            }
            if (document.getElementById('btn-pay-ecash')) {
                document.getElementById('btn-pay-ecash').addEventListener('click', () => {
                    if (checkShiftBeforePayment('ECASH')) openECashCheckout();
                });
            }
            document.getElementById('btn-clear-cart').addEventListener('click', clearCart);
            document.getElementById('btn-discount').addEventListener('click', applyDiscount);

            // Checkout modal
            document.getElementById('amount-received').addEventListener('input', updateChange);
            document.getElementById('btn-complete-sale').addEventListener('click', completeSale);

            // Block 'e', 'E', '+', '-' keys in amount input (number inputs allow these for scientific notation)
            document.getElementById('amount-received').addEventListener('keydown', function (e) {
                if (['e', 'E', '+', '-'].includes(e.key)) {
                    e.preventDefault();
                }
            });

            // Mobile: Cart header click to toggle
            const cartHeader = document.querySelector('.cart-header');
            if (cartHeader) {
                cartHeader.addEventListener('click', function () {
                    if (window.innerWidth <= 992) {
                        toggleMobileCart();
                    }
                });
            }
        });

        // Mobile Cart Toggle
        function toggleMobileCart() {
            const cartSection = document.querySelector('.cart-section');
            cartSection.classList.toggle('expanded');
        }

        // Update mobile cart badge
        function updateMobileCartBadge() {
            const badge = document.getElementById('mobile-cart-badge');
            if (badge) {
                const count = cart.reduce((sum, i) => sum + i.quantity, 0);
                badge.textContent = count;
                badge.style.display = count > 0 ? 'flex' : 'none';
            }
        }

        // Customer Search Logic
        function initCustomerSearch() {
            const searchInput = document.getElementById('customer-search');
            const suggestions = document.getElementById('customer-suggestions');
            const clearBtn = document.getElementById('btn-clear-customer');

            searchInput.addEventListener('input', function () {
                const query = this.value.trim().toLowerCase();
                suggestions.innerHTML = '';

                if (query.length < 1) {
                    suggestions.classList.remove('show');
                    return;
                }

                const matches = CUSTOMERS.filter(c =>
                    c.name.toLowerCase().includes(query) ||
                    c.phone.includes(query)
                );

                if (matches.length > 0) {
                    matches.forEach(c => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.innerHTML = `
                            <div>
                                <div>${c.name}</div>
                                <small class="text-muted">${c.phone}</small>
                            </div>
                            <div class="${c.current_balance > 0 ? 'text-danger' : 'text-success'}">
                                ${CURRENCY}${c.current_balance}
                            </div>
                        `;
                        div.onclick = () => selectCustomer(c);
                        suggestions.appendChild(div);
                    });
                    suggestions.classList.add('show');
                } else {
                    suggestions.classList.remove('show');
                }
            });

            clearBtn.addEventListener('click', function () {
                selectedCustomer = null;
                searchInput.value = '';
                document.getElementById('selected-customer-info').style.display = 'none';
                this.style.display = 'none';
                document.getElementById('btn-pay-credit').style.display = 'none';
            });
        }

        function selectCustomer(customer) {
            selectedCustomer = customer;
            const searchInput = document.getElementById('customer-search');
            const suggestions = document.getElementById('customer-suggestions');

            searchInput.value = customer.name;
            suggestions.classList.remove('show');
            document.getElementById('btn-clear-customer').style.display = 'block';

            // Show info
            const infoDiv = document.getElementById('selected-customer-info');
            document.getElementById('cust-name').textContent = customer.name;
            document.getElementById('cust-balance').textContent = `${CURRENCY}${customer.current_balance}`;
            document.getElementById('cust-balance').className = customer.current_balance > 0 ? 'text-danger' : 'text-success';

            if (customer.credit_limit) {
                const available = parseFloat(customer.credit_limit) - parseFloat(customer.current_balance);
                document.getElementById('cust-limit').textContent = `Limit: ${CURRENCY}${customer.credit_limit} (Avail: ${CURRENCY}${available.toFixed(2)})`;
            } else {
                document.getElementById('cust-limit').textContent = 'No Credit Limit';
            }

            infoDiv.style.display = 'block';

            // Enable Credit Button and Payment on Account
            const payCredit = document.getElementById('btn-pay-credit');
            payCredit.style.display = 'flex';
            payCredit.disabled = false;

            // Also enable Pay Cash for payment on account (even if cart is empty)
            document.getElementById('btn-pay-cash').disabled = false;

            // Enable E-Cash button too
            const ecashBtn = document.getElementById('btn-pay-ecash');
            if (ecashBtn) ecashBtn.disabled = false;
        }

        function openCheckout(mode) {
            // Allow checkout if cart has items OR if it's a payment on account (customer selected with empty cart)
            const isPaymentOnAccount = cart.length === 0 && selectedCustomer;
            if (cart.length === 0 && !isPaymentOnAccount) return;

            paymentMode = mode;

            const modal = document.getElementById('checkout-modal');
            const total = calculateTotal();

            document.getElementById('modal-total').textContent = CURRENCY + total.toFixed(2);
            document.getElementById('amount-received').value = '';
            document.getElementById('modal-change').textContent = CURRENCY + '0.00';

            // UI Toggle based on mode
            const title = document.getElementById('checkout-title');
            const creditInfo = document.getElementById('credit-payment-info');
            const amountContainer = document.getElementById('amount-received-container');
            const changeContainer = document.getElementById('change-container');

            if (isPaymentOnAccount) {
                // Payment on account mode - paying into customer's account
                title.innerHTML = '<i class="bi bi-wallet me-2"></i>Payment on Account';
                creditInfo.style.display = 'block';
                amountContainer.style.display = 'block';
                changeContainer.style.display = 'none';

                document.getElementById('credit-current-balance').textContent = CURRENCY + parseFloat(selectedCustomer.current_balance).toFixed(2);
                document.getElementById('credit-new-balance').textContent = '(Will update based on payment)';
                document.getElementById('credit-limit-warning').innerHTML =
                    '<span class="text-info"><i class="bi bi-info-circle"></i> Enter amount to pay into this customer\'s account.</span>';
                document.getElementById('btn-complete-sale').disabled = false;

            } else if (mode === 'CREDIT') {
                title.innerHTML = '<i class="bi bi-credit-card-2-front me-2"></i>Pay on Credit';
                creditInfo.style.display = 'block';
                amountContainer.style.display = 'none';
                changeContainer.style.display = 'none';

                // Show balance impact
                document.getElementById('credit-current-balance').textContent = CURRENCY + parseFloat(selectedCustomer.current_balance).toFixed(2);
                const newBalance = parseFloat(selectedCustomer.current_balance) + total;
                document.getElementById('credit-new-balance').textContent = CURRENCY + newBalance.toFixed(2);

                // Check limit
                if (selectedCustomer.credit_limit && newBalance > parseFloat(selectedCustomer.credit_limit)) {
                    document.getElementById('credit-limit-warning').innerHTML =
                        `<span class="text-danger"><i class="bi bi-exclamation-triangle"></i> Credit Limit Exceeded! Cannot proceed.</span>`;
                    document.getElementById('btn-complete-sale').disabled = true;
                } else {
                    document.getElementById('credit-limit-warning').innerHTML = '';
                    document.getElementById('btn-complete-sale').disabled = false;
                }

                // Auto-fill amount for backend logic
                document.getElementById('amount-received').value = 0;
            } else {
                // CASH payment mode
                title.innerHTML = '<i class="bi bi-cash-coin me-2"></i>Cash Payment';
                amountContainer.style.display = 'block';
                changeContainer.style.display = 'block';
                document.getElementById('btn-complete-sale').disabled = false;

                // Show customer info if selected (for partial payments / overpayments)
                if (selectedCustomer) {
                    creditInfo.style.display = 'block';
                    document.getElementById('credit-current-balance').textContent = CURRENCY + parseFloat(selectedCustomer.current_balance).toFixed(2);
                    document.getElementById('credit-new-balance').textContent = '(Updates with payment)';
                    document.getElementById('credit-limit-warning').innerHTML =
                        '<span class="text-muted small"><i class="bi bi-info-circle"></i> Pay less: remaining credited. Pay more: reduces balance or stores credit.</span>';
                } else {
                    creditInfo.style.display = 'none';
                }
            }

            modal.classList.add('active');
            if (mode === 'CASH' || isPaymentOnAccount) {
                // Use setTimeout to ensure focus after modal is fully rendered
                setTimeout(() => {
                    const amountInput = document.getElementById('amount-received');
                    amountInput.focus();
                    amountInput.select(); // Also select any existing value
                }, 100);
            }
        }

        function openCashCheckout() {
            openCheckout('CASH');
        }

        // Search Autocomplete
        function initSearchAutocomplete() {
            const searchInput = document.getElementById('product-search');
            const suggestions = document.getElementById('search-suggestions');
            let selectedIndex = -1;
            let currentMatches = [];

            searchInput.addEventListener('input', function () {
                const query = this.value.trim().toLowerCase();
                selectedIndex = -1;

                if (query.length < 1) {
                    suggestions.classList.remove('show');
                    renderProducts('');
                    return;
                }

                // Filter products matching the query
                currentMatches = PRODUCTS.filter(p => {
                    const matchCategory = currentCategory === 'all' || p.category === currentCategory;
                    const matchSearch = p.name.toLowerCase().includes(query) ||
                        p.sku.toLowerCase().includes(query);
                    return matchSearch && matchCategory;
                }).slice(0, 8); // Limit to 8 suggestions

                if (currentMatches.length === 0) {
                    suggestions.innerHTML = '<div class="suggestion-empty">No products found</div>';
                } else {
                    suggestions.innerHTML = currentMatches.map((p, index) => `
                        <div class="suggestion-item" data-index="${index}" data-product-id="${p.id}">
                            <div>
                                <span class="suggestion-name">${highlightMatch(p.name, query)}</span>
                                <span class="suggestion-sku">${p.sku}</span>
                            </div>
                            <span class="suggestion-price">${CURRENCY}${parseFloat(p.price).toFixed(2)}</span>
                        </div>
                    `).join('');

                    // Add click handlers
                    suggestions.querySelectorAll('.suggestion-item').forEach(item => {
                        item.addEventListener('click', function () {
                            const productId = parseInt(this.dataset.productId);
                            addToCart(productId);
                            searchInput.value = '';
                            suggestions.classList.remove('show');
                            renderProducts('');
                        });
                    });
                }

                suggestions.classList.add('show');

                // Also filter the product grid
                renderProducts(query);
            });

            // Keyboard navigation
            searchInput.addEventListener('keydown', function (e) {
                const items = suggestions.querySelectorAll('.suggestion-item');

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateSuggestionSelection(items, selectedIndex);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateSuggestionSelection(items, selectedIndex);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedIndex >= 0 && items[selectedIndex]) {
                        const productId = parseInt(items[selectedIndex].dataset.productId);
                        addToCart(productId);
                        searchInput.value = '';
                        suggestions.classList.remove('show');
                        renderProducts('');
                    } else if (currentMatches.length === 1) {
                        // If only one match, add it directly
                        addToCart(currentMatches[0].id);
                        searchInput.value = '';
                        suggestions.classList.remove('show');
                        renderProducts('');
                    }
                } else if (e.key === 'Escape') {
                    suggestions.classList.remove('show');
                    searchInput.blur();
                }
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', function (e) {
                if (!searchInput.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.classList.remove('show');
                }
            });

            // Focus search on any keypress (for barcode scanners)
            document.addEventListener('keydown', function (e) {
                // Only focus if not already in an input and not a special key
                if (document.activeElement.tagName !== 'INPUT' &&
                    !e.ctrlKey && !e.altKey && !e.metaKey &&
                    e.key.length === 1) {
                    searchInput.focus();
                }
            });
        }

        function updateSuggestionSelection(items, index) {
            items.forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });
            // Scroll into view if needed
            if (index >= 0 && items[index]) {
                items[index].scrollIntoView({ block: 'nearest' });
            }
        }

        function highlightMatch(text, query) {
            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<strong style="color: var(--pos-success)">$1</strong>');
        }

        function renderProducts(search = '') {
            const grid = document.getElementById('products-grid');
            const searchLower = search.toLowerCase();

            let filtered = PRODUCTS.filter(p => {
                const matchSearch = !search ||
                    p.name.toLowerCase().includes(searchLower) ||
                    p.sku.toLowerCase().includes(searchLower);
                const matchCategory = currentCategory === 'all' || p.category === currentCategory;
                return matchSearch && matchCategory;
            });

            grid.innerHTML = filtered.map(p => {
                // Determine badge color based on quantity vs threshold
                const qty = p.quantity || 0;
                const threshold = p.threshold || 0;
                let badgeClass = 'badge-good';

                if (threshold > 0) {
                    if (qty <= threshold) {
                        badgeClass = 'badge-critical';
                    } else if (qty < threshold * 2) {
                        badgeClass = 'badge-warning';
                    }
                }

                return `
                    <div class="product-card" onclick="addToCart(${p.id})">
                        <div class="product-quantity-badge ${badgeClass}">${Math.floor(qty)}</div>
                        <div class="product-name">${p.name}</div>
                        <div class="product-price">${CURRENCY}${parseFloat(p.price).toFixed(2)}</div>
                    </div>
                `;
            }).join('');
        }

        function addToCart(productId) {
            const product = PRODUCTS.find(p => p.id === productId);
            if (!product) return;

            const existing = cart.find(item => item.id === productId);
            if (existing) {
                existing.quantity += 1;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: parseFloat(product.price),
                    quantity: 1
                });
            }

            updateCart();
            saveCartToStorage();
        }

        function updateItemQty(productId, delta) {
            const item = cart.find(i => i.id === productId);
            if (!item) return;

            item.quantity += delta;
            if (item.quantity <= 0) {
                cart = cart.filter(i => i.id !== productId);
            }

            updateCart();
            saveCartToStorage();
        }

        function removeItem(productId) {
            cart = cart.filter(i => i.id !== productId);
            updateCart();
            saveCartToStorage();
        }

        function updateCart() {
            const cartDiv = document.getElementById('cart-items');
            const countEl = document.getElementById('cart-count');

            if (cart.length === 0) {
                cartDiv.innerHTML = `
                    <div class="cart-empty">
                        <i class="bi bi-cart-x"></i>
                        <p>Cart is empty</p>
                        <small>Click products to add</small>
                    </div>
                `;
                countEl.textContent = '0';
            } else {
                cartDiv.innerHTML = cart.map(item => `
                    <div class="cart-item">
                        <div>
                            <div class="cart-item-name">${item.name}</div>
                            <small class="text-muted">${CURRENCY}${item.price.toFixed(2)} each</small>
                        </div>
                        <div class="cart-item-qty">
                            <button class="qty-btn" onclick="updateItemQty(${item.id}, -1)">-</button>
                            <span class="qty-value">${item.quantity}</span>
                            <button class="qty-btn" onclick="updateItemQty(${item.id}, 1)">+</button>
                            <span class="cart-item-remove" onclick="removeItem(${item.id})">
                                <i class="bi bi-x-lg"></i>
                            </span>
                        </div>
                    </div>
                `).join('');
                countEl.textContent = cart.reduce((sum, i) => sum + i.quantity, 0);
            }

            updateTotals();
        }

        function updateTotals() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const total = subtotal - discountAmount;

            document.getElementById('cart-subtotal').textContent = CURRENCY + subtotal.toFixed(2);
            document.getElementById('cart-discount').textContent = '-' + CURRENCY + discountAmount.toFixed(2);
            document.getElementById('cart-total').textContent = CURRENCY + total.toFixed(2);

            const hasItems = cart.length > 0;
            document.getElementById('btn-pay-cash').disabled = !hasItems;
            const ecashBtn = document.getElementById('btn-pay-ecash');
            if (ecashBtn) ecashBtn.disabled = !hasItems;

            // Update mobile cart badge
            updateMobileCartBadge();
        }

        function calculateTotal() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            return subtotal - discountAmount;
        }

        function clearCart() {
            if (!confirm('Clear the cart?')) return;
            cart = [];
            discountAmount = 0;
            updateCart();
            saveCartToStorage();
        }

        function applyDiscount() {
            const amount = prompt('Enter discount amount:', discountAmount);
            if (amount !== null) {
                discountAmount = Math.max(0, parseFloat(amount) || 0);
                updateTotals();
                saveCartToStorage();
            }
        }

        function openCashCheckout() {
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0) - discountAmount;
            document.getElementById('modal-total').textContent = CURRENCY + total.toFixed(2);
            document.getElementById('amount-received').value = '';
            document.getElementById('modal-change').textContent = CURRENCY + '0.00';
            document.getElementById('checkout-modal').classList.add('active');
            document.getElementById('amount-received').focus();
        }

        function closeCheckoutModal() {
            document.getElementById('checkout-modal').classList.remove('active');
        }

        // Shift prompt modal functions
        function openShiftPromptModal(mode) {
            pendingPaymentMode = mode;
            document.getElementById('shift-prompt-modal').classList.add('active');
        }

        function closeShiftPromptModal() {
            document.getElementById('shift-prompt-modal').classList.remove('active');
            pendingPaymentMode = null;
        }

        function openShiftAndReturn() {
            // Cart is already saved to localStorage, just navigate
            window.location.href = '{% url "sales:shift_open" %}';
        }

        function continueWithoutShift() {
            closeShiftPromptModal();
            if (pendingPaymentMode === 'ECASH') {
                openECashCheckout();
            } else {
                openCheckout(pendingPaymentMode);
            }
        }

        // Check shift before allowing payment - called by payment buttons
        function checkShiftBeforePayment(mode) {
            if (!HAS_SHIFT) {
                openShiftPromptModal(mode);
                return false;
            }
            return true;
        }

        // Enter key handler for checkout modal
        document.addEventListener('keydown', function (e) {
            const checkoutModal = document.getElementById('checkout-modal');
            const shiftModal = document.getElementById('shift-prompt-modal');

            if (e.key === 'Enter') {
                // Complete sale if checkout modal is open
                if (checkoutModal.classList.contains('active')) {
                    e.preventDefault();
                    document.getElementById('btn-complete-sale').click();
                }
                // Default action (Open Shift) if shift prompt is open
                if (shiftModal.classList.contains('active')) {
                    e.preventDefault();
                    openShiftAndReturn();
                }
            }
            // Escape key to close modals
            if (e.key === 'Escape') {
                if (checkoutModal.classList.contains('active')) {
                    closeCheckoutModal();
                }
                if (shiftModal.classList.contains('active')) {
                    closeShiftPromptModal();
                }
            }
        });
        // E-Cash Payment via Paystack
        async function openECashCheckout() {
            // Check for payment on account (customer selected with empty cart)
            const isPaymentOnAccount = cart.length === 0 && selectedCustomer;

            if (cart.length === 0 && !selectedCustomer) {
                alert('Cart is empty! Select a customer for payment on account.');
                return;
            }

            let total;

            if (isPaymentOnAccount) {
                // Payment on account - ask for amount
                const amountStr = prompt(
                    `E-Cash Payment on Account for ${selectedCustomer.name}\n` +
                    `Current Balance: ${CURRENCY}${selectedCustomer.current_balance}\n\n` +
                    'Enter payment amount:'
                );
                if (!amountStr) return;  // User cancelled

                total = parseFloat(amountStr);
                if (isNaN(total) || total <= 0) {
                    alert('Please enter a valid payment amount.');
                    return;
                }
            } else {
                // Normal cart sale
                total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0) - discountAmount;
            }

            if (total <= 0) {
                alert('Invalid total amount for payment.');
                return;
            }

            // First, create a pending sale to get reference
            try {
                const response = await fetch('{% url "sales:initialize_ecash_payment" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': CSRF_TOKEN
                    },
                    body: JSON.stringify({
                        items: cart.map(item => ({
                            product_id: item.id,
                            quantity: item.quantity,
                            unit_price: item.price
                        })),
                        discount_amount: discountAmount,
                        customer_id: selectedCustomer ? selectedCustomer.id : null,
                        total: total,
                        is_payment_on_account: isPaymentOnAccount
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    alert(data.error || 'Failed to initialize payment.');
                    return;
                }

                // Open Paystack popup
                const handler = PaystackPop.setup({
                    key: data.paystack_public_key,
                    email: data.customer_email || 'customer@example.com',
                    amount: Math.round(total * 100), // Convert to pesewas
                    currency: 'GHS',
                    ref: data.reference,
                    metadata: {
                        tenant_id: data.tenant_id,
                        sale_id: data.sale_id,
                        custom_fields: [
                            {
                                display_name: "Sale Number",
                                variable_name: "sale_number",
                                value: data.sale_number
                            }
                        ]
                    },
                    callback: function (response) {
                        // Payment successful - verify and complete
                        verifyECashPayment(response.reference, data.sale_id, data.is_payment_on_account, data.customer_id, total);
                    },
                    onClose: function () {
                        // User closed popup without completing
                        console.log('Payment popup closed');
                    }
                });

                handler.openIframe();

            } catch (error) {
                console.error('E-Cash error:', error);
                alert('Failed to initialize e-cash payment. Please try again.');
            }
        }

        // Verify and complete e-cash payment
        async function verifyECashPayment(reference, saleId, isPaymentOnAccount = false, customerId = null, amount = 0) {
            try {
                const response = await fetch('{% url "sales:verify_ecash_payment" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': CSRF_TOKEN
                    },
                    body: JSON.stringify({
                        reference: reference,
                        sale_id: saleId,
                        is_payment_on_account: isPaymentOnAccount,
                        customer_id: customerId,
                        amount: amount
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Reset cart
                    cart = [];
                    discountAmount = 0;
                    selectedCustomer = null;
                    updateCart();
                    saveCartToStorage();

                    // Reset customer UI
                    document.getElementById('customer-search').value = '';
                    document.getElementById('btn-clear-customer').style.display = 'none';
                    document.getElementById('selected-customer-info').style.display = 'none';
                    document.getElementById('btn-pay-credit').style.display = 'none';

                    alert('E-Cash payment successful!');

                    // Open appropriate receipt
                    if (data.is_payment_on_account && data.transaction_id) {
                        // Payment on account receipt
                        window.open(`/customers/payment/${data.transaction_id}/receipt/`, '_blank');
                    } else if (data.sale_id) {
                        // Sale receipt
                        window.open(`/sales/${data.sale_id}/receipt/`, '_blank');
                    }
                } else {
                    alert(data.error || 'Payment verification failed. Please contact support.');
                }
            } catch (error) {
                console.error('Verification error:', error);
                alert('Failed to verify payment. Please check your transaction history.');
            }
        }

        function updateChange() {
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0) - discountAmount;
            const received = parseFloat(document.getElementById('amount-received').value) || 0;
            const change = Math.max(0, received - total);
            document.getElementById('modal-change').textContent = CURRENCY + change.toFixed(2);

            // Update new balance display if customer selected
            if (selectedCustomer) {
                const currentBalance = parseFloat(selectedCustomer.current_balance);
                let newBalance;

                if (cart.length === 0) {
                    // Payment on account - payment reduces balance
                    newBalance = currentBalance - received;
                } else {
                    // Sale with payment
                    const unpaid = Math.max(0, total - received);
                    const overpayment = Math.max(0, received - total);
                    newBalance = currentBalance + unpaid - overpayment;
                }

                const newBalanceEl = document.getElementById('credit-new-balance');
                if (newBalanceEl) {
                    newBalanceEl.textContent = CURRENCY + newBalance.toFixed(2);
                    newBalanceEl.className = newBalance > 0 ? 'text-danger' : 'text-success';
                }
            }
        }

        async function completeSale() {
            // Allow if cart has items OR payment on account (customer selected with empty cart)
            const isPaymentOnAccount = cart.length === 0 && selectedCustomer;
            if (cart.length === 0 && !isPaymentOnAccount) return;

            const received = parseFloat(document.getElementById('amount-received').value) || 0;
            const total = calculateTotal();

            // For CASH without customer, require full payment
            // For CASH with customer, allow partial payment (rest goes to credit)
            if (paymentMode === 'CASH' && received < total && !selectedCustomer) {
                alert('Amount received is less than total!');
                return;
            }

            // For payment on account, require an amount
            if (isPaymentOnAccount && received <= 0) {
                alert('Please enter an amount to pay on account.');
                return;
            }

            const btn = document.getElementById('btn-complete-sale');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';

            try {
                const response = await fetch('/sales/api/checkout/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': CSRF_TOKEN
                    },
                    body: JSON.stringify({
                        items: cart.map(item => ({
                            product_id: item.id,
                            quantity: item.quantity,
                            unit_price: item.price
                        })),
                        amount_paid: received,
                        payment_method: isPaymentOnAccount ? 'PAYMENT_ON_ACCOUNT' : paymentMode,
                        discount_amount: discountAmount,
                        customer_id: selectedCustomer ? selectedCustomer.id : null,
                        is_payment_on_account: isPaymentOnAccount
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Reset cart data
                    cart = [];
                    discountAmount = 0;
                    selectedCustomer = null;
                    updateCart();
                    saveCartToStorage();

                    // Reset customer UI
                    document.getElementById('customer-search').value = '';
                    document.getElementById('btn-clear-customer').style.display = 'none';
                    document.getElementById('selected-customer-info').style.display = 'none';
                    document.getElementById('btn-pay-credit').style.display = 'none';

                    closeCheckoutModal();

                    // Open receipt for printing
                    if (isPaymentOnAccount && data.transaction_id) {
                        // Payment on account receipt
                        window.open(`/customers/payment/${data.transaction_id}/receipt/`, '_blank');
                    } else if (data.sale_id) {
                        // Sale receipt
                        window.open(`/sales/${data.sale_id}/receipt/`, '_blank');
                    }

                    // Reload window to update stock
                    setTimeout(() => location.reload(), 500);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to process sale');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        function saveCartToStorage() {
            localStorage.setItem('pos_cart', JSON.stringify({ cart, discountAmount }));
        }

        function loadCartFromStorage() {
            try {
                const saved = localStorage.getItem('pos_cart');
                if (saved) {
                    const data = JSON.parse(saved);
                    cart = data.cart || [];
                    discountAmount = data.discountAmount || 0;
                    updateCart();
                }
            } catch (e) { }
        }
    </script>
</body>

</html>